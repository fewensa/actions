name: 'Clone Any Git Repo Action'

description: "Clone any git repository in Github Actions"

inputs:
  repository:
    description: 'Repository url'
    required: true
  access_token:
    description: 'Access token with http protocol'
    required: false
  ssh_key:
    description: 'SSH private key'
    required: false
  ssh_host:
    description: 'SSH server host, will auto scan known hosts by this value'
    required: false
  target:
    description: 'Clone target dir name'
    required: false

runs:
  using: "composite"
  steps:

    - name: Clone
      shell: bash
      id: deploy_vercel
      run: |
        set -e
        REPOSITORY=${{ inputs.repository }}
        ACCESS_TOKEN=${{ inputs.access_token }}
        SSH_KEY=${{ inputs.ssh_key }}
        SSH_HOST=${{ inputs.ssh_host }}
        TARGET_NAME=${{ inputs.target }}


        mkdir -p ~/.ssh

        if [ -n "$SSH_KEY" ]; then
          eval $(ssh-agent -s)
          echo "$SSH_KEY" | tr -d '\r' | ssh-add -
        fi

        if [ -n "$SSH_HOST" ]; then
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
        fi

        Z_REPOSITORY=$REPOSITORY

        if [ -n "$ACCESS_TOKEN" ]; then
          if [[ $REPOSITORY =~ 'https://.*' ]]; then
              Z_REPOSITORY=$(echo $REPOSITORY | sed -e "s/https:\/\//https:\/\/${ACCESS_TOKEN}@/g")
          fi
          if [[ $REPOSITORY =~ 'http://.*' ]]; then
              Z_REPOSITORY=$(echo $REPOSITORY | sed -e "s/http:\/\//http:\/\/${ACCESS_TOKEN}@/g")
          fi
        fi

        echo 'Repository:' $Z_REPOSITORY
        if [ -z "$TARGET_NAME" ]; then
            # git clone $Z_REPOSITORY .
            
            git clone $Z_REPOSITORY repo
            chmod -R 777 ./repo
            mv ./repo/* ./
            rm -rf ./repo

            echo "Cloned $Z_REPOSITORY repository successfully."
        else
            git clone $Z_REPOSITORY $TARGET_NAME
            chmod -R 777 ./$TARGET_NAME

            echo "Cloned $Z_REPOSITORY repository successfully."
            echo "Access the repository content using \"cd $TARGET_NAME\"."
        fi


